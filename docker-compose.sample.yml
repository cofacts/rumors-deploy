version: '2'
services:

  site:
    image: cofacts/rumors-site:latest-en
    environment:
      - PORT=3000
      - NODE_ENV=production
      - SERVER_ROLLBAR_TOKEN=
      - PUBLIC_ROLLBAR_TOKEN=
      - PUBLIC_ROLLBAR_ENV=
      - PUBLIC_API_URL=http://api:5000
      - PUBLIC_GTM_ID=
      - SERVER_STACKIMPACT_AGENT_KEY=
      - SERVER_STACKIMPACT_APP_NAME=
    ports:
      - "3000:3000"
    depends_on:
      - api

  api:
    image: cofacts/rumors-api
    environment:
      - ELASTICSEARCH_URL=http://db:9200
      - ELASTIC_LOG_LEVEL=info
      - PORT=5000
      - COOKIE_SECRETS=
      - ROLLBAR_TOKEN=
      - ROLLBAR_ENV=production
      - HTTP_HEADER_APP_ID=x-app-id
      - HTTP_HEADER_APP_SECRET=x-app-secret
      - RUMORS_SITE_CORS_ORIGIN=http://localhost:3000
      - RUMORS_SITE_REDIRECT_ORIGIN=http://localhost:3000
      - RUMORS_LINE_BOT_SECRET=CHANGE_ME
      - FACEBOOK_APP_ID=
      - FACEBOOK_SECRET=
      - FACEBOOK_CALLBACK_URL=http://localhost:5000/callback/facebook
      - TWITTER_CONSUMER_KEY=
      - TWITTER_CONSUMER_SECRET
      - TWITTER_CALLBACK_URL=http://localhost:5000/callback/twitter
      - GITHUB_CLIENT_ID=
      - GITHUB_SECRET=
      - GITHUB_CALLBACK_URL=http://localhost:5000/callback/github
      - URL_RESOLVER_URL=url-resolver:4000
      - GOOGLE_OAUTH_KEY_PATH=/data/service-account-key.json
      - GA_WEB_VIEW_ID=
      - GA_LINE_VIEW_ID=
      - TIMEZONE=+08:00
      - TRUST_PROXY_HEADERS=
      - COOKIE_SAMESITE_NONE=
    volumes:
      - "./volumes/api:/data"
    ports:
      - "5000:5000"
    depends_on:
      - db
      - url-resolver

  db:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:6.3.2
    environment:
      - "path.repo=/usr/share/elasticsearch/data"
    volumes:
      - "./volumes/db-sample:/usr/share/elasticsearch/data"
    ports:
      - "62222:9200"

  url-resolver:
    image: cofacts/url-resolver
    ports: # expose for debugging
      - "4000:4000"
    environment:
      - YOUTUBE_API_KEY=
      - ROLLBAR_TOKEN=
      - ROLLBAR_ENV=production

  line-bot-zh:
    image: cofacts/rumors-line-bot:dev
    environment:
      # Build-time variables
      - LOCALE=en_US
      - ROLLBAR_ENV=localhost
      - ROLLBAR_CLIENT_TOKEN=
      - GA_ID=
      - LIFF_URL=https://liff.line.me/<liff-id>
      - APP_ID=RUMORS_LINE_BOT
      - API_URL=https://dev-api.cofacts.tw/graphql
      - SITE_URLS=https://dev.cofacts.tw

      # Runtime secrets
      - LINE_CHANNEL_SECRET=
      - LINE_CHANNEL_TOKEN=
      - LINE_LOGIN_CHANNEL_ID=
      - REDIS_URL=redis://redis:6379
      - PORT=5001
      - ROLLBAR_TOKEN=

      # This should match rumors-api's RUMORS_LINE_BOT_SECRET
      - APP_SECRET=CHANGE_ME
      - GOOGLE_CREDENTIALS=
      - GOOGLE_DRIVE_IMAGE_FOLDER=
      - USERID_BLACKLIST=
      - FACEBOOK_APP_ID=719656818195367
      - IMAGE_MESSAGE_ENABLED=false
      - MAX_IMAGE_PROCESS_NUMBER=3
      - LIFF_DEV_PORT=8080
      - JWT_SECRET=secret
      - MONGODB_URI=mongodb://root:root-test-password@mongo:27017/cofacts?authSource=admin
      - NOTIFY_METHOD=PUSH_MESSAGE
      - LINE_NOTIFY_CLIENT_ID=
      - LINE_NOTIFY_CLIENT_SECRET=
      - RUMORS_LINE_BOT_URL=
      # For query ListReplies form lastSacnAt to current+buffer
      #{"years": 2, "months": 9, "weeks": 1, "days": 7, "hours": 5, "minutes": 9, "seconds": 30,}
      - REVIEW_REPLY_BUFFER={"seconds":0,"minutes":0,"hours":-12,"days":0}
      - LINE_FRIEND_URL=https://line.me/R/ti/p/@cofacts
      - DAILOGFLOW_CLIENT_EMAIL=
      - DAILOGFLOW_PRIVATE_KEY=
      - DAILOGFLOW_PROJECT_ID=
      - DAILOGFLOW_LANGUAGE=
      - DAILOGFLOW_ENV=
      - JOBQUEUE_CONCURRENCY=3

    ports:
      - "5001:5001"
    depends_on:
      - api
      - redis

  redis:
    image: redis

  mongo:
    image: mongo:3.6
    environment:
        - MONGO_INITDB_ROOT_USERNAME=root
        - MONGO_INITDB_ROOT_PASSWORD=root-test-password
    ports:
      - "27017:27017"
    volumes:
      - "./data/mongo:/data/db"
    command: mongod
